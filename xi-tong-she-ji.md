# ☺ 系统设计

## 商品库存管理如何防止超卖？

防止商品超卖是一个常见的设计问题，可以通过以下几种方式来解决：

1. 悲观锁：在商品库存减少时，使用数据库的悲观锁机制，例如使用数据库的行级锁或表级锁来保证在修改库存时的数据一致性。这种方式可以保证同时只有一个线程能够修改库存，从而避免超卖问题。
2. 乐观锁：在商品库存减少时，使用乐观锁机制，即在更新库存的同时检查库存是否足够，如果不够则回滚事务。在数据库中使用版本号或时间戳等字段来实现乐观锁，每次更新时检查版本号或时间戳是否一致，如果不一致则表示有其他线程已经修改过数据。
3. 分布式锁：在进行库存减少操作时，使用分布式锁来保证只有一个线程能够执行减少库存的操作。可以使用Redis、ZooKeeper等工具实现分布式锁。通过获取锁的线程执行库存减少操作，其他线程则等待锁的释放。
4. 预扣库存：在用户下单前，先对商品库存进行预扣减，但是不实际减少库存。只有在用户支付成功后，再实际扣减库存。如果用户在一定时间内未支付，则释放预扣减的库存，让其他用户可以购买。
5. 排队系统：通过引入排队系统，将用户的购买请求进行排队，保证每个请求按顺序执行。当一个请求完成后，再处理下一个请求。这样可以避免并发操作导致的超卖问题。

无论选择哪种方式，都需要注意在高并发环境下进行性能测试和压力测试，确保系统能够稳定运行，并且合理设置库存的初始值和阈值，避免因为初始库存不足或者阈值设置不合理导致的超卖问题。



